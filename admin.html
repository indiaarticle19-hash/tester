<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="description" content="Admin — Prabha Graphics" />
  <title>Prabha Graphics — Admin</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{--primary:#D10007;--muted:#6b7280;--bg:#f7f7f8}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Poppins',sans-serif;background:var(--bg);color:#111827}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .navbar{position:fixed;top:0;left:0;right:0;background:#fff;z-index:1000;box-shadow:0 0 0 rgba(0,0,0,0);transition:all .25s}
    .nav-container{max-width:1280px;margin:0 auto;padding:16px 28px;display:flex;align-items:center;gap:16px;justify-content:space-between}
    .logo-circle{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--primary);color:#fff;font-weight:700}
    .nav-links{display:flex;gap:20px}
    .admin-wrap{margin-top:100px}
    .card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:16px}
    .row{display:flex;gap:12px}
    input,select,textarea,button{font-family:inherit}
    input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;margin-top:8px}
    .btn{background:var(--primary);color:#fff;padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
    .btn.secondary{background:#374151}
    .small{font-size:13px;color:var(--muted)}
    .products-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .product-item{border:1px solid #eee;padding:10px;border-radius:8px;background:#fff}
    .thumb{width:100%;height:120px;object-fit:cover;border-radius:6px}
    .orders-grid{display:grid;gap:12px}
    .order-card{background:#fff;border-radius:8px;padding:10px;border:1px solid #eee}
    .hidden{display:none}
    @media (max-width:900px){ .row{flex-direction:column} .nav-links{display:none} }
  </style>
</head>
<body>

  <!-- same header -->
  <nav class="navbar">
    <div class="nav-container container">
      <div style="display:flex;align-items:center;gap:12px;cursor:pointer" onclick="location.href='index.html'">
        <div class="logo-circle">PG</div><strong>Prabha Graphics</strong>
      </div>
      <div style="display:flex;gap:12px;align-items:center">
        <a href="products.html" class="small">Products</a>
        <a href="get-a-quote.html" class="small">Get a Quote</a>
      </div>
    </div>
  </nav>

  <div class="container admin-wrap">
    <!-- LOGIN CARD (mandatory - no register) -->
    <div id="loginCard" class="card">
      <h3>Admin Login</h3>
      <div id="loginError" class="small" style="color:#991b1b"></div>
      <input id="email" placeholder="admin@example.com" type="email"/>
      <input id="password" placeholder="Password" type="password"/>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="btnLogin" class="btn">Sign in</button>
      </div>
      <p class="small" style="margin-top:8px;color:#6b7280">Note: Admin sign-in is required to access dashboard.</p>
    </div>

    <!-- ADMIN PANEL (hidden until login) -->
    <div id="panel" class="hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Products — Add / Edit</h3>
          <div style="display:flex;gap:8px">
            <button id="btnSignOut" class="btn secondary">Sign out</button>
            <a href="products.html" class="btn secondary">Open Shop</a>
          </div>
        </div>

        <form id="productForm" style="margin-top:12px">
          <input id="productId" type="hidden"/>
          <div class="row">
            <div style="flex:2">
              <input id="pName" placeholder="Product name" required/>
            </div>
            <div style="flex:1">
              <input id="pSKU" placeholder="SKU"/>
            </div>
          </div>

          <div class="row" style="margin-top:8px">
            <div>
              <select id="pType"><option value="ready-made">Ready-made</option><option value="customized">Customized</option></select>
            </div>
            <div>
              <input id="pCategory" placeholder="Category (Corporate, Personalized, Business, Apparel)"/>
            </div>
            <div>
              <input id="pVendor" placeholder="Vendor/Brand"/>
            </div>
          </div>

          <div class="row" style="margin-top:8px">
            <div><input id="pPrice" type="number" placeholder="Base Price"/></div>
            <div><input id="pStock" type="number" placeholder="Stock"/></div>
            <div><input id="pTags" placeholder="Tags (comma separated)"/></div>
          </div>

          <div style="margin-top:8px">
            <textarea id="pDesc" rows="3" placeholder="Full description"></textarea>
          </div>

          <div style="margin-top:8px">
            <label><input type="radio" name="imgSrc" value="urls" checked/> Image URLs</label>
            <label style="margin-left:12px"><input type="radio" name="imgSrc" value="upload"/> Upload</label>
          </div>

          <div id="imgUrlsBox" style="margin-top:8px">
            <textarea id="pImageUrls" rows="2" placeholder="Comma separated image URLs"></textarea>
          </div>

          <div id="imgUploadBox" style="display:none;margin-top:8px">
            <input id="pFiles" type="file" accept="image/*" multiple/>
            <div id="pPreview" style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap"></div>
          </div>

          <div style="margin-top:8px">
            <input id="pSizes" placeholder="Sizes (comma separated)"/>
            <input id="pColors" placeholder="Colors (comma separated)" style="margin-top:8px"/>
            <textarea id="pVariants" placeholder='Variants JSON (eg: [{"id":"v1","label":"S","price":499,"stock":10}])' rows="3" style="margin-top:8px"></textarea>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px">
            <button type="submit" class="btn">Save Product</button>
            <button type="button" id="btnClear" class="btn secondary">Clear</button>
          </div>
          <div id="productMsg" style="margin-top:8px"></div>
        </form>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Products List (grouped)</h3>
        <div style="margin-top:8px">
          <h4>Ready-made</h4>
          <div id="readyGrid" class="products-grid"></div>

          <h4 style="margin-top:12px">Customized</h4>
          <div id="customGrid" class="products-grid"></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Orders</h3>
        <div style="margin-top:8px">
          <div id="ordersList" class="orders-grid"></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Get-a-Quote Submissions</h3>
        <div id="quotesList" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- Footer (same) -->
  <footer style="background:#111827;color:#fff;padding:28px;margin-top:20px">
    <div class="container" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px">
      <div>
        <div style="display:flex;align-items:center;gap:8px"><div class="logo-circle">PG</div><strong>Prabha Graphics</strong></div>
        <p style="color:#d1d5db;margin-top:8px">Admin dashboard — manage products, orders, and quotes.</p>
      </div>
      <div>
        <h4 style="color:#fff">Contact</h4>
        <p style="color:#d1d5db">074579 94888</p>
      </div>
    </div>
  </footer>

  <!-- Firebase + Admin logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, doc, setDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, getDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAj405kZSn-V6rOKE1BurRE3meYCGZ_wbU",
      authDomain: "prabha-graphics-7d269.firebaseapp.com",
      projectId: "prabha-graphics-7d269",
      storageBucket: "prabha-graphics-7d269.appspot.com",
      messagingSenderId: "968671773486",
      appId: "1:968671773486:web:234c477f4ba267f31770bf",
      measurementId: "G-52C61FGY39"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // UI refs
    const loginCard = document.getElementById('loginCard');
    const panel = document.getElementById('panel');
    const email = document.getElementById('email');
    const password = document.getElementById('password');
    const btnLogin = document.getElementById('btnLogin');
    const btnSignOut = document.getElementById('btnSignOut');
    const loginError = document.getElementById('loginError');

    const productForm = document.getElementById('productForm');
    const productId = document.getElementById('productId');
    const pName = document.getElementById('pName');
    const pSKU = document.getElementById('pSKU');
    const pType = document.getElementById('pType');
    const pCategory = document.getElementById('pCategory');
    const pVendor = document.getElementById('pVendor');
    const pPrice = document.getElementById('pPrice');
    const pStock = document.getElementById('pStock');
    const pTags = document.getElementById('pTags');
    const pDesc = document.getElementById('pDesc');
    const pImageUrls = document.getElementById('pImageUrls');
    const pFiles = document.getElementById('pFiles');
    const pPreview = document.getElementById('pPreview');
    const imgUrlsBox = document.getElementById('imgUrlsBox');
    const imgUploadBox = document.getElementById('imgUploadBox');
    const pSizes = document.getElementById('pSizes');
    const pColors = document.getElementById('pColors');
    const pVariants = document.getElementById('pVariants');
    const productMsg = document.getElementById('productMsg');
    const btnClear = document.getElementById('btnClear');

    const readyGrid = document.getElementById('readyGrid');
    const customGrid = document.getElementById('customGrid');
    const ordersList = document.getElementById('ordersList');
    const quotesList = document.getElementById('quotesList');

    // Login (no register)
    btnLogin.addEventListener('click', async ()=> {
      loginError.textContent = '';
      const e = email.value.trim(); const p = password.value;
      if(!e||!p) return loginError.textContent = 'Email & password required';
      try{
        await signInWithEmailAndPassword(auth, e, p);
      } catch(err){
        loginError.textContent = 'Sign-in failed: '+ err.message;
      }
    });

    btnSignOut.addEventListener('click', async ()=>{ await signOut(auth); });

    onAuthStateChanged(auth, user => {
      if(user){
        loginCard.style.display='none'; panel.classList.remove('hidden');
        startProductsListener(); startOrdersListener(); startQuotesListener();
      } else {
        loginCard.style.display='block'; panel.classList.add('hidden');
        stopListeners();
      }
    });

    // toggle image source
    document.querySelectorAll('input[name="imgSrc"]').forEach(r=>{
      r.addEventListener('change', ()=> {
        if (r.checked && r.value === 'upload'){ imgUploadBox.style.display='block'; imgUrlsBox.style.display='none'; }
        else { imgUploadBox.style.display='none'; imgUrlsBox.style.display='block'; }
      });
    });

    // preview files
    pFiles.addEventListener('change', ()=> {
      pPreview.innerHTML = '';
      const files = Array.from(pFiles.files || []);
      files.forEach(f => {
        const url = URL.createObjectURL(f);
        const img = document.createElement('img'); img.src = url; img.style.width='80px'; img.style.height='80px'; img.style.objectFit='cover'; img.style.borderRadius='6px';
        pPreview.appendChild(img);
      });
    });

    // Save product (create or update)
    productForm.addEventListener('submit', async (e)=> {
      e.preventDefault(); productMsg.textContent=''; productMsg.className='';
      const id = productId.value || null;
      const docData = {
        name: pName.value.trim(),
        sku: pSKU.value.trim(),
        type: pType.value,
        category: pCategory.value.trim(),
        vendor: pVendor.value.trim(),
        price: parseFloat(pPrice.value) || 0,
        stock: parseInt(pStock.value) || 0,
        tags: pTags.value.split(',').map(s=>s.trim()).filter(Boolean),
        description: pDesc.value.trim(),
        sizes: pSizes.value.split(',').map(s=>s.trim()).filter(Boolean),
        colors: pColors.value.split(',').map(s=>s.trim()).filter(Boolean),
        variants: []
      };
      const variantsText = pVariants.value.trim();
      if (variantsText){
        try { docData.variants = JSON.parse(variantsText); } catch(err){ productMsg.textContent='Variants JSON invalid: '+err.message; productMsg.className='error'; return; }
      }

      try {
        // handle uploaded files
        const files = Array.from(pFiles.files || []);
        const uploadedUrls = []; const uploadedPaths = [];
        for (const f of files){
          const path = `products/${Date.now()}_${f.name}`;
          const sRef = storageRef(storage, path);
          const task = uploadBytesResumable(sRef, f);
          await new Promise((res, rej)=> {
            task.on('state_changed', ()=>{}, err=> rej(err), async ()=> {
              const url = await getDownloadURL(task.snapshot.ref);
              uploadedUrls.push(url); uploadedPaths.push(path); res();
            });
          });
        }
        const urlList = (pImageUrls.value||'').split(',').map(s=>s.trim()).filter(Boolean);
        docData.images = [...urlList, ...uploadedUrls];
        if (uploadedPaths.length) docData.imageStoragePaths = uploadedPaths;

        if (!id){
          docData.createdAt = serverTimestamp();
          await addDoc(collection(db,'products'), docData);
          productForm.reset(); pPreview.innerHTML=''; productMsg.textContent='Product created.'; productMsg.className='success';
        } else {
          await updateDoc(doc(db,'products', id), docData);
          productForm.reset(); pPreview.innerHTML=''; productId.value=''; productMsg.textContent='Product updated.'; productMsg.className='success';
        }
      } catch(err){
        console.error(err); productMsg.textContent='Save failed: '+err.message; productMsg.className='error';
      }
    });

    btnClear.addEventListener('click', ()=> { productForm.reset(); productId.value=''; pPreview.innerHTML=''; productMsg.textContent=''; });

    // Products listener + edit/delete
    let productsUnsub = null;
    function startProductsListener(){
      if (productsUnsub) return;
      const q = query(collection(db,'products'), orderBy('createdAt','desc'));
      productsUnsub = onSnapshot(q, snapshot => {
        readyGrid.innerHTML = customGrid.innerHTML = '';
        snapshot.forEach(docSnap => {
          const d = docSnap.data(); d.id = docSnap.id;
          const el = document.createElement('div'); el.className='product-item';
          el.innerHTML = `
            <img src="${escapeHtml((d.images && d.images[0])||'')}" class="thumb" />
            <div style="margin-top:8px"><strong>${escapeHtml(d.name)}</strong></div>
            <div class="small" style="color:#6b7280">${escapeHtml(d.category||'')} • SKU: ${escapeHtml(d.sku||'')}</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn btn-edit" data-id="${d.id}">Edit</button>
              <button class="btn secondary btn-delete" data-id="${d.id}" data-path='${JSON.stringify(d.imageStoragePaths||[])}'>Delete</button>
            </div>
          `;
          if (d.type === 'customized') customGrid.appendChild(el); else readyGrid.appendChild(el);
        });
        // attach handlers
        document.querySelectorAll('.btn-edit').forEach(b=>{
          b.onclick = async ()=> {
            const id = b.dataset.id; const snap = await getDoc(doc(db,'products',id));
            if (!snap.exists()) return alert('Not found');
            const d = snap.data();
            productId.value = snap.id; pName.value=d.name||''; pSKU.value=d.sku||''; pType.value=d.type||'ready-made';
            pCategory.value=d.category||''; pVendor.value=d.vendor||''; pPrice.value=d.price||''; pStock.value=d.stock||'';
            pTags.value=(d.tags||[]).join(','); pDesc.value=d.description||'';
            pSizes.value=(d.sizes||[]).join(','); pColors.value=(d.colors||[]).join(','); pVariants.value=d.variants && d.variants.length ? JSON.stringify(d.variants,null,2):'';
            pImageUrls.value=(d.images||[]).join(',');
            pPreview.innerHTML='';
            (d.images||[]).forEach(u=>{ const img=document.createElement('img'); img.src=u; img.style.width='80px'; img.style.height='80px'; img.style.objectFit='cover'; img.style.borderRadius='6px'; pPreview.appendChild(img); });
            window.scrollTo({top:0,behavior:'smooth'});
          };
        });
        document.querySelectorAll('.btn-delete').forEach(b=>{
          b.onclick = async ()=> {
            if (!confirm('Delete product?')) return;
            const id = b.dataset.id; const paths = JSON.parse(b.getAttribute('data-path')||'[]');
            try{ await deleteDoc(doc(db,'products',id)); for (const p of paths) await deleteObject(storageRef(storage,p)).catch(()=>{}); alert('Deleted'); } catch(err){ alert('Delete failed: '+err.message); }
          };
        });
      }, err=> console.error(err));
    }

    // Orders listener
    let ordersUnsub = null;
    function startOrdersListener(){
      if (ordersUnsub) return;
      const q = query(collection(db,'orders'), orderBy('createdAt','desc'));
      ordersUnsub = onSnapshot(q, snapshot => {
        ordersList.innerHTML = '';
        snapshot.forEach(docSnap => {
          const o = docSnap.data(); const id = docSnap.id;
          const el = document.createElement('div'); el.className='order-card';
          el.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>${escapeHtml(o.productName || '')}</strong><div class="small" style="color:#6b7280">${escapeHtml(o.customerName||'')} • ${escapeHtml(o.customerPhone||'')}</div></div>
              <div><span style="background:#f3f4f6;padding:6px;border-radius:6px">${escapeHtml(o.status||'pending')}</span></div>
            </div>
            <div style="margin-top:8px;color:#374151">${escapeHtml((o.address && o.address.line1) || '')} ${escapeHtml((o.address && o.address.city) || '')} - ${escapeHtml((o.address && o.address.pincode) || '')}</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn btn-update" data-id="${id}" data-status="processing">Processing</button>
              <button class="btn secondary btn-update" data-id="${id}" data-status="shipped">Shipped</button>
              <button class="btn secondary btn-update" data-id="${id}" data-status="delivered">Delivered</button>
              <button class="btn secondary btn-view" data-id="${id}">View</button>
              <button class="btn secondary btn-delete-order" data-id="${id}">Delete</button>
            </div>
          `;
          ordersList.appendChild(el);
        });

        document.querySelectorAll('.btn-update').forEach(b=>{
          b.onclick = async ()=> {
            const id = b.dataset.id; const status = b.dataset.status;
            try { await updateDoc(doc(db,'orders',id), { status, updatedAt: serverTimestamp() }); } catch(err){ console.error(err); }
          };
        });

        document.querySelectorAll('.btn-view').forEach(b=>{
          b.onclick = async ()=> {
            const id = b.dataset.id; const snap = await getDoc(doc(db,'orders',id));
            if (!snap.exists()) return alert('Not found');
            const o = snap.data();
            alert([
              `Product: ${o.productName}`,
              `Qty: ${o.quantity}`,
              `Name: ${o.customerName}`,
              `Phone: ${o.customerPhone}`,
              `Email: ${o.customerEmail || '-'}`,
              `Address: ${ (o.address && (o.address.line1 + ' ' + o.address.line2 + ', ' + o.address.city + ' - ' + o.address.pincode)) || '-' }`,
              `Status: ${o.status || '-'}`,
              `Note: ${o.note || '-'}`
            ].join('\n\n'));
          };
        });

        document.querySelectorAll('.btn-delete-order').forEach(b=>{
          b.onclick = async ()=> {
            if(!confirm('Delete order?')) return;
            const id = b.dataset.id; try{ await deleteDoc(doc(db,'orders',id)); alert('Deleted'); } catch(err){ alert('Delete failed: '+err.message); }
          };
        });

      }, err=> console.error(err));
    }

    // Quotes listener
    let quotesUnsub = null;
    function startQuotesListener(){
      if (quotesUnsub) return;
      const q = query(collection(db,'quotes'), orderBy('createdAt','desc'));
      quotesUnsub = onSnapshot(q, snapshot => {
        quotesList.innerHTML = '';
        snapshot.forEach(docSnap => {
          const qd = docSnap.data(); const id = docSnap.id;
          const el = document.createElement('div'); el.className='product-item';
          el.innerHTML = `
            <strong>${escapeHtml(qd.name||'')}</strong>
            <div class="small" style="color:#6b7280">${escapeHtml(qd.phone||'')}</div>
            <div style="margin-top:6px">${escapeHtml(qd.message||'')}</div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="btn secondary btn-delete-quote" data-id="${id}">Delete</button>
            </div>
          `;
          quotesList.appendChild(el);
        });

        document.querySelectorAll('.btn-delete-quote').forEach(b=>{
          b.onclick = async ()=> {
            if(!confirm('Delete quote?')) return;
            const id = b.dataset.id; try{ await deleteDoc(doc(db,'quotes',id)); alert('Deleted'); } catch(err){ alert('Delete failed: '+err.message); }
          };
        });

      }, err=> console.error(err));
    }

    // stop listeners on sign out
    function stopListeners(){
      if (productsUnsub) { productsUnsub(); productsUnsub = null; }
      if (ordersUnsub) { ordersUnsub(); ordersUnsub = null; }
      if (quotesUnsub) { quotesUnsub(); quotesUnsub = null; }
      readyGrid.innerHTML = customGrid.innerHTML = ordersList.innerHTML = quotesList.innerHTML = '';
    }

    // small helper
    function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g,m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

  </script>
</body>
</html>
