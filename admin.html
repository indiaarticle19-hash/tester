<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prabha Graphics — Admin</title>

  <!-- Fonts & Icons (same as site) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#D10007;
      --accent:#374151;
      --muted:#6b7280;
      --bg:#fafafa;
      --card-shadow: 0 8px 24px rgba(16,24,40,0.06);
      --max-width:1280px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:var(--bg);color:#111}
    a{text-decoration:none;color:inherit}

    /* Header */
    .navbar{position:fixed;top:0;left:0;right:0;background:#fff;z-index:1000;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
    .nav-container{max-width:var(--max-width);margin:0 auto;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;gap:16px}
    .nav-logo{display:flex;align-items:center;gap:12px;cursor:pointer}
    .logo-circle{width:44px;height:44;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    .logo-text{font-weight:700}
    .nav-links{display:flex;gap:18px;align-items:center;list-style:none;margin:0;padding:0}
    .nav-link{color:#111;font-weight:600}
    .cta-btn{background:var(--primary);color:#fff;padding:8px 14px;border-radius:8px;border:0;cursor:pointer}

    /* Layout */
    .container{max-width:1200px;margin:110px auto 40px;padding:0 20px}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:20px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} .nav-links{display:none} .container{margin-top:120px} }

    /* Cards */
    .card{background:#fff;padding:16px;border-radius:12px;box-shadow:var(--card-shadow)}
    h2{margin:0 0 8px;font-size:20px}
    .small{font-size:13px;color:var(--muted)}

    /* Forms */
    label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
    input[type=text],input[type=number],select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;margin-top:6px;font-size:14px}
    textarea{min-height:88px;resize:vertical}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row .col{flex:1;min-width:0}
    .btn{background:var(--primary);color:#fff;padding:10px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
    .btn.secondary{background:var(--accent)}
    .btn.ghost{background:#fff;border:1px solid #e6e6e6;color:var(--accent)}
    .btn.danger{background:#fff;border:1px solid #f8d7da;color:#7f1d1d}

    /* Lists */
    .product-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-top:12px}
    .product-item{background:#fff;border-radius:10px;overflow:hidden;border:1px solid #efefef;display:flex;flex-direction:column}
    .product-item img{width:100%;height:160px;object-fit:cover}
    .product-body{padding:10px;display:flex;flex-direction:column;gap:6px}
    .muted{color:var(--muted);font-size:13px}
    .meta-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .meta{font-size:12px;color:var(--muted);background:#f8fafc;padding:6px 8px;border-radius:8px}

    /* Orders / Quotes */
    .order-card{background:#fff;padding:12px;border-radius:8px;border:1px solid #eee;margin-bottom:12px}
    .address-block{background:#fafafa;padding:10px;border-radius:8px;border:1px solid #f1f1f1;margin-top:8px}
    .status-badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#f3f4f6;font-size:13px;color:#111}

    /* Upload preview */
    #uploadPreview img{width:80px;height:80px;object-fit:cover;border-radius:6px}

    /* Footer small note */
    .note{font-size:13px;color:#666;text-align:center;margin:18px 0}

  </style>
</head>
<body>
  <!-- Header -->
  <nav class="navbar" id="navbar">
    <div class="nav-container">
      <div class="nav-logo" onclick="location.href='index.html'">
        <div class="logo-circle">PG</div>
        <span class="logo-text">Prabha Graphics</span>
      </div>

      <ul class="nav-links" id="navLinks">
        <li><a class="nav-link" href="index.html">Home</a></li>
        <li><a class="nav-link" href="index.html#about">About Us</a></li>
        <li><a class="nav-link" href="products.html">Products</a></li>
        <li><a class="nav-link" href="get-a-quote.html">Get a Quote</a></li>
      </ul>

      <button class="cta-btn" onclick="location.href='get-a-quote.html'">Get a Quote</button>
    </div>
  </nav>

  <main class="container">
    <div class="grid">
      <!-- Left: auth + editor + product list -->
      <div>
        <div class="card" id="authCard">
          <h2>Admin Login</h2>
          <p class="small">Sign in with Email & Password</p>
          <label>Email</label>
          <input id="adminEmail" type="text" placeholder="admin@example.com" />
          <label>Password</label>
          <input id="adminPassword" type="password" placeholder="Password" />
          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="signInBtn" class="btn">Sign in</button>
            <button id="signOutBtn" class="btn secondary" style="display:none">Sign out</button>
          </div>
          <div id="authMsg" class="small" style="margin-top:8px;color:#b91c1c"></div>
        </div>

        <div id="panelArea" style="display:none">
          <div class="card" style="margin-top:16px">
            <h2>Add / Edit Product</h2>
            <div class="small">Categories: Apparel, Personalized Products, Corporate Gifts, Business Essentials</div>

            <input id="prodId" type="hidden" />

            <label>Main Category</label>
            <select id="mainCategory">
              <option>Apparel</option>
              <option>Personalized Products</option>
              <option>Corporate Gifts</option>
              <option>Business Essentials</option>
            </select>

            <label>Sub-category</label>
            <select id="subCategory"></select>

            <div class="row">
              <div class="col">
                <label>Product Name</label>
                <input id="pName" type="text" placeholder="e.g. Classic Cotton T-Shirt" />
              </div>
              <div class="col" style="max-width:150px">
                <label>Price (₹)</label>
                <input id="pPrice" type="number" placeholder="499" />
              </div>
              <div class="col" style="max-width:150px">
                <label>Old Price (₹)</label>
                <input id="pOldPrice" type="number" placeholder="699" />
              </div>
            </div>

            <label>Unique Code (SKU) — auto-generated</label>
            <input id="pSKU" type="text" readonly />

            <label>Image URL (preferred)</label>
            <input id="pImageUrl" type="text" placeholder="https://..." />

            <label>Or upload images (optional)</label>
            <input id="pFiles" type="file" accept="image/*" multiple />
            <div id="uploadPreview" style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap"></div>

            <label>Description</label>
            <textarea id="pDescription" placeholder="Product description"></textarea>

            <div class="row">
              <div class="col">
                <label>Sizes (comma separated)</label>
                <input id="pSizes" placeholder="S,M,L,XL" />
              </div>
              <div class="col">
                <label>Colors (comma separated)</label>
                <input id="pColors" placeholder="Red,Black,White" />
              </div>
              <div class="col">
                <label>Tags (comma separated)</label>
                <input id="pTags" placeholder="party,bulk,gift" />
              </div>
            </div>

            <div class="row" style="align-items:end">
              <div class="col" style="max-width:160px">
                <label>Minimum Order Quantity</label>
                <input id="pMinQty" type="number" placeholder="1" />
              </div>
              <div class="col" style="max-width:160px">
                <label>Stock</label>
                <input id="pStock" type="number" placeholder="50" />
              </div>
              <div class="col" style="max-width:180px">
                <label>Vendor</label>
                <input id="pVendor" type="text" placeholder="Prabha Graphics" />
              </div>
            </div>

            <div class="row">
              <div class="col">
                <label>Material</label>
                <input id="pMaterial" type="text" placeholder="Cotton, Ceramic, etc." />
              </div>
              <div class="col">
                <label>Dimensions</label>
                <input id="pDimensions" type="text" placeholder="10 x 12 cm" />
              </div>
              <div class="col">
                <label>Weight</label>
                <input id="pWeight" type="text" placeholder="250 g" />
              </div>
            </div>

            <!-- Bulk pricing / rating / warranty -->
            <div style="margin-top:10px">
              <label>Bulk pricing (price per unit)</label>
              <div class="row">
                <div style="max-width:170px"><input id="bulk10" type="number" placeholder="Price for 10+" /><div class="small">≥10</div></div>
                <div style="max-width:170px"><input id="bulk50" type="number" placeholder="Price for 50+" /><div class="small">≥50</div></div>
                <div style="max-width:170px"><input id="bulk100" type="number" placeholder="Price for 100+" /><div class="small">≥100</div></div>
              </div>

              <div class="row" style="margin-top:10px;align-items:end">
                <div style="max-width:160px">
                  <label>Rating (0.0 - 5.0)</label>
                  <input id="pRating" type="number" min="0" max="5" step="0.1" placeholder="4.5" />
                </div>
                <div>
                  <label>Warranty / Guarantee</label>
                  <input id="pWarranty" type="text" placeholder="e.g., 1 year manufacturer warranty" />
                </div>
                <div style="max-width:160px">
                  <label>Type</label>
                  <select id="pTypeSelect">
                    <option value="ready-made">Ready-made</option>
                    <option value="customized">Customized</option>
                  </select>
                </div>
              </div>
            </div>

            <div style="display:flex;gap:8px;margin-top:12px">
              <button id="saveProduct" class="btn">Save Product</button>
              <button id="clearProduct" class="btn secondary">Clear</button>
            </div>
            <div id="prodMsg" class="small" style="margin-top:8px"></div>
          </div>

          <div class="card" style="margin-top:14px">
            <h2>Products (click Edit)</h2>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div class="small">Live synced with Firestore</div>
              <div style="display:flex;gap:8px">
                <input id="searchInput" placeholder="Search by name/SKU/tag" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6" />
                <select id="filterCategory" style="padding:8px;border-radius:8px;border:1px solid #e6e6e6">
                  <option value="">All categories</option>
                  <option>Apparel</option>
                  <option>Personalized Products</option>
                  <option>Corporate Gifts</option>
                  <option>Business Essentials</option>
                </select>
              </div>
            </div>
            <div class="product-list" id="productsList">Loading…</div>
          </div>
        </div>
      </div>

      <!-- Right: orders & quotes -->
      <aside>
        <div class="card">
          <h2>Orders</h2>
          <div id="ordersArea" class="orders">Loading orders…</div>
        </div>

        <div class="card" style="margin-top:14px">
          <h2>Get-a-Quote Requests</h2>
          <div id="quotesArea" class="quotes">Loading quotes…</div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Footer (site identical look) -->
  <footer id="contact" class="footer" style="margin-top:30px">
    <div class="container" style="max-width:var(--max-width);padding:0 20px">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:28px;margin-bottom:28px">
        <div>
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
            <div class="logo-circle">PG</div><strong>Prabha Graphics</strong>
          </div>
          <p style="color:#d1d5db">Your trusted partner in Lucknow for corporate and personalized printing and gifting needs.</p>
        </div>

        <div>
          <h3 style="margin:0 0 8px 0">Quick Links</h3>
          <div style="color:#d1d5db">T-Shirts • Mugs • Keychains • Clocks • Custom Gifts</div>
        </div>

        <div>
          <h3 style="margin:0 0 8px 0">Company</h3>
          <div style="color:#d1d5db">About Us • Contact Us • View Full Catalog</div>
        </div>

        <div>
          <h3 style="margin:0 0 8px 0">Contact Us</h3>
          <div style="color:#d1d5db"><i class="fas fa-phone"></i> 074579 94888</div>
          <div style="color:#d1d5db;margin-top:6px"><i class="fas fa-map-marker-alt"></i> Shop No. 4/74, Adarsh Market, Gomti Nagar, Lucknow, Uttar Pradesh 226010</div>
          <div style="color:#d1d5db;margin-top:6px"><i class="fas fa-globe"></i> www.prabhagraphics.in</div>
        </div>
      </div>

      <div style="height:1px;background:linear-gradient(to right, transparent, rgba(209,0,7,0.12), transparent);margin-bottom:18px"></div>
      <div style="text-align:center;color:#9ca3af">&copy; 2025 Prabha Graphics. All rights reserved.</div>
    </div>
  </footer>

  <p class="note">Note: Firestore collections used: <code>products</code>, <code>orders</code>, <code>quotes</code>. Ensure Email/Password auth is enabled and Firestore rules allow writes for authenticated admin and creates for orders/quotes.</p>

  <script type="module">
    /* ---------------- Firebase setup ---------------- */
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js';
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, getDoc } from 'https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js';
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.6.0/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAj405kZSn-V6rOKE1BurRE3meYCGZ_wbU",
      authDomain: "prabha-graphics-7d269.firebaseapp.com",
      projectId: "prabha-graphics-7d269",
      storageBucket: "prabha-graphics-7d269.appspot.com",
      messagingSenderId: "968671773486",
      appId: "1:968671773486:web:234c477f4ba267f31770bf",
      measurementId: "G-52C61FGY39"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    /* ---------------- UI refs ---------------- */
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const adminEmail = document.getElementById('adminEmail');
    const adminPassword = document.getElementById('adminPassword');
    const authMsg = document.getElementById('authMsg');

    const panelArea = document.getElementById('panelArea');
    const prodId = document.getElementById('prodId');
    const mainCategory = document.getElementById('mainCategory');
    const subCategory = document.getElementById('subCategory');
    const pName = document.getElementById('pName');
    const pPrice = document.getElementById('pPrice');
    const pOldPrice = document.getElementById('pOldPrice');
    const pSKU = document.getElementById('pSKU');
    const pImageUrl = document.getElementById('pImageUrl');
    const pFiles = document.getElementById('pFiles');
    const uploadPreview = document.getElementById('uploadPreview');
    const pDescription = document.getElementById('pDescription');
    const pSizes = document.getElementById('pSizes');
    const pColors = document.getElementById('pColors');
    const pTags = document.getElementById('pTags');
    const pMinQty = document.getElementById('pMinQty');
    const pTypeSelect = document.getElementById('pTypeSelect');
    const pStock = document.getElementById('pStock');
    const pVendor = document.getElementById('pVendor');
    const pMaterial = document.getElementById('pMaterial');
    const pDimensions = document.getElementById('pDimensions');
    const pWeight = document.getElementById('pWeight');
    const bulk10 = document.getElementById('bulk10');
    const bulk50 = document.getElementById('bulk50');
    const bulk100 = document.getElementById('bulk100');
    const pRating = document.getElementById('pRating');
    const pWarranty = document.getElementById('pWarranty');

    const saveProduct = document.getElementById('saveProduct');
    const clearProduct = document.getElementById('clearProduct');
    const prodMsg = document.getElementById('prodMsg');
    const productsList = document.getElementById('productsList');

    const ordersArea = document.getElementById('ordersArea');
    const quotesArea = document.getElementById('quotesArea');

    const searchInput = document.getElementById('searchInput');
    const filterCategory = document.getElementById('filterCategory');

    /* ---------------- Sub-cats ---------------- */
    const subMap = {
      'Apparel': ['T-shirts','Hoodies','Polo','Jackets','Caps'],
      'Personalized Products': ['Mugs','Photo Frames','Cushions','Phone Covers','Bottles','Keychains'],
      'Corporate Gifts': ['Pens','Notebooks','Gift Hampers','Corporate T-shirts','Gift Boxes'],
      'Business Essentials': ['Visiting Cards','Letterheads','Lanyards','Stamps','Banners']
    };
    function populateSub(){
      const list = subMap[mainCategory.value] || [];
      subCategory.innerHTML = '';
      list.forEach(s=> subCategory.innerHTML += `<option>${s}</option>`);
      if (!list.length) subCategory.innerHTML = '<option>Other</option>';
    }
    mainCategory.addEventListener('change', populateSub);
    populateSub();

    /* ---------------- Auth ---------------- */
    signInBtn.addEventListener('click', async ()=>{
      authMsg.textContent = '';
      const e = adminEmail.value.trim(); const p = adminPassword.value;
      if (!e || !p) { authMsg.textContent = 'Email and password required'; return; }
      try{ await signInWithEmailAndPassword(auth, e, p); }
      catch(err){ authMsg.textContent = 'Sign-in failed: ' + err.message; }
    });
    signOutBtn.addEventListener('click', async ()=>{ await signOut(auth); });

    let unsubProducts=null, unsubOrders=null, unsubQuotes=null;
    onAuthStateChanged(auth, user =>{
      if (user){
        authMsg.textContent = ''; signInBtn.style.display='none'; signOutBtn.style.display='inline-block'; panelArea.style.display='block'; document.getElementById('authCard').style.display='none';
        startListeners();
      } else {
        signInBtn.style.display='inline-block'; signOutBtn.style.display='none'; panelArea.style.display='none'; document.getElementById('authCard').style.display='block';
        stopListeners();
      }
    });

    /* ---------------- SKU generator ---------------- */
    function generateSKU(category){
      const prefix = (category || 'PR').split(' ').map(w=>w[0]).join('').toUpperCase();
      const ts = Date.now().toString(36).toUpperCase();
      const rnd = Math.floor(Math.random()*900+100).toString();
      return `${prefix}-${ts}-${rnd}`;
    }

    /* preview uploads */
    pFiles.addEventListener('change', ()=>{
      uploadPreview.innerHTML = '';
      Array.from(pFiles.files || []).forEach(f=>{
        const url = URL.createObjectURL(f);
        const img = document.createElement('img'); img.src = url; uploadPreview.appendChild(img);
      });
    });

    /* ---------------- Save product ---------------- */
    saveProduct.addEventListener('click', async ()=>{
      prodMsg.textContent = '';
      const name = pName.value.trim(); if(!name) return prodMsg.textContent='Product name required';
      const mainCat = mainCategory.value; const subCat = subCategory.value || 'Other';
      const price = parseFloat(pPrice.value) || 0;
      const oldPrice = parseFloat(pOldPrice.value) || null;
      const stock = parseInt(pStock.value) || 0;
      const sku = pSKU.value || generateSKU(mainCat);

      const product = {
        name,
        mainCategory: mainCat,
        subCategory: subCat,
        category: `${mainCat} • ${subCat}`,
        price,
        oldPrice: oldPrice || null,
        sku,
        description: pDescription.value.trim(),
        sizes: (pSizes.value||'').split(',').map(s=>s.trim()).filter(Boolean),
        colors: (pColors.value||'').split(',').map(s=>s.trim()).filter(Boolean),
        tags: (pTags.value||'').split(',').map(s=>s.trim()).filter(Boolean),
        minQty: parseInt(pMinQty.value) || 1,
        type: pTypeSelect.value || 'ready-made',
        stock,
        vendor: pVendor.value.trim() || 'Prabha Graphics',
        material: pMaterial.value.trim() || '',
        dimensions: pDimensions.value.trim() || '',
        weight: pWeight.value.trim() || '',
        // New fields
        bulkPricing: {
          '10': Number(bulk10.value) || null,
          '50': Number(bulk50.value) || null,
          '100': Number(bulk100.value) || null
        },
        rating: (pRating.value ? Number(pRating.value) : null),
        warranty: pWarranty.value.trim() || '',
        createdAt: serverTimestamp()
      };

      // Upload files if any
      const files = Array.from(pFiles.files || []);
      product.images = [];
      try{
        for(const f of files){
          const path = `products/${sku}_${Date.now()}_${f.name}`;
          const r = storageRef(storage, path);
          const task = uploadBytesResumable(r, f);
          await new Promise((res,rej)=> task.on('state_changed', ()=>{}, err=> rej(err), async ()=>{ product.images.push(await getDownloadURL(task.snapshot.ref)); res(); }));
        }
      }catch(err){
        console.error('upload failed', err);
        prodMsg.textContent = 'Upload failed: ' + err.message;
      }

      if (pImageUrl.value && !product.images.length) product.images.push(pImageUrl.value.trim());

      try{
        if(prodId.value){
          await updateDoc(doc(db, 'products', prodId.value), product);
          prodMsg.textContent = 'Product updated';
        } else {
          await addDoc(collection(db, 'products'), product);
          prodMsg.textContent = 'Product added';
        }
        setTimeout(()=> clearForm(), 900);
      }catch(err){
        console.error(err);
        prodMsg.textContent = 'Save failed: ' + err.message;
      }
    });

    clearProduct.addEventListener('click', clearForm);
    function clearForm(){ prodId.value=''; pName.value=''; pPrice.value=''; pOldPrice.value=''; pSKU.value=''; pImageUrl.value=''; pFiles.value=''; uploadPreview.innerHTML=''; pDescription.value=''; pSizes.value=''; pColors.value=''; pTags.value=''; pMinQty.value=''; pTypeSelect.value='ready-made'; pStock.value=''; pVendor.value=''; pMaterial.value=''; pDimensions.value=''; pWeight.value=''; bulk10.value=''; bulk50.value=''; bulk100.value=''; pRating.value=''; pWarranty.value=''; prodMsg.textContent=''; }

    /* ---------------- Listeners ---------------- */
    function startListeners(){
      if (unsubProducts) return;

      unsubProducts = onSnapshot(query(collection(db,'products'), orderBy('createdAt','desc')), snap=>{
        productsList.innerHTML='';
        const productCache = {};
        snap.forEach(docSnap=>{
          const d = docSnap.data(); d.id = docSnap.id; productCache[d.id]=d;
          const el = document.createElement('div'); el.className='product-item';
          const discount = d.oldPrice && d.price && d.oldPrice > d.price ? Math.round(((d.oldPrice - d.price)/d.oldPrice)*100) : 0;
          const ratingText = d.rating ? `★ ${d.rating}` : '';
          const warrantyText = d.warranty ? d.warranty : '';
          el.innerHTML = `
            <img src="${escapeHtml((d.images && d.images[0]) || d.imageUrl || 'https://via.placeholder.com/400x300?text=No+Image')}" alt="">
            <div class="product-body">
              <strong>${escapeHtml(d.name)}</strong>
              <div class="muted">${escapeHtml(d.mainCategory || '')} • ${escapeHtml(d.subCategory || '')}</div>
              <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;margin-top:6px">
                <div style="display:flex;gap:8px;align-items:center">
                  ${discount ? `<span class="meta">-${discount}%</span>` : `<span class="meta">${escapeHtml(d.type||'ready-made')}</span>`}
                  ${ratingText ? `<span class="meta">${escapeHtml(ratingText)}</span>` : ''}
                  ${warrantyText ? `<span class="meta">${escapeHtml(warrantyText)}</span>` : ''}
                </div>
                <div style="color:var(--primary);font-weight:700">₹${escapeHtml(String(d.price || 0))}</div>
              </div>
              <div class="muted">SKU: ${escapeHtml(d.sku || '')}</div>
              <div class="actions">
                <button class="btn small edit-btn" data-id="${d.id}">Edit</button>
                <button class="btn secondary small quick-order-btn" data-id="${d.id}">WhatsApp</button>
                <button class="btn danger small delete-btn" data-id="${d.id}">Delete</button>
              </div>
            </div>
          `;
          productsList.appendChild(el);
        });

        // attach handlers
        document.querySelectorAll('.edit-btn').forEach(b=> b.onclick = async ()=>{
          const id=b.dataset.id;
          const dref = doc(db,'products',id);
          const snap = await getDoc(dref);
          if(!snap.exists()) return alert('Not found');
          const d = snap.data();
          prodId.value = snap.id;
          mainCategory.value = d.mainCategory || 'Apparel';
          populateSub();
          subCategory.value = d.subCategory || subCategory.value;
          pName.value = d.name||'';
          pPrice.value = d.price||0;
          pOldPrice.value = d.oldPrice || '';
          pSKU.value = d.sku || generateSKU(mainCategory.value);
          pImageUrl.value = (d.images && d.images[0]) || d.imageUrl || '';
          pDescription.value = d.description||'';
          pSizes.value = (d.sizes||[]).join(',');
          pColors.value = (d.colors||[]).join(',');
          pTags.value = (d.tags||[]).join(',');
          pMinQty.value = d.minQty||1;
          pTypeSelect.value = d.type||'ready-made';
          pStock.value = d.stock || '';
          pVendor.value = d.vendor || 'Prabha Graphics';
          pMaterial.value = d.material || '';
          pDimensions.value = d.dimensions || '';
          pWeight.value = d.weight || '';
          bulk10.value = (d.bulkPricing && d.bulkPricing['10']) ? d.bulkPricing['10'] : '';
          bulk50.value = (d.bulkPricing && d.bulkPricing['50']) ? d.bulkPricing['50'] : '';
          bulk100.value = (d.bulkPricing && d.bulkPricing['100']) ? d.bulkPricing['100'] : '';
          pRating.value = d.rating || '';
          pWarranty.value = d.warranty || '';
          uploadPreview.innerHTML = '';
          (d.images||[]).forEach(u=>{ const img=document.createElement('img'); img.src=u; uploadPreview.appendChild(img); });
          window.scrollTo({top:0,behavior:'smooth'});
        });

        document.querySelectorAll('.quick-order-btn').forEach(b=> b.onclick = ()=>{
          const id=b.dataset.id;
          const p = productCache[id];
          const msg = p ? `Hi, query about: ${p.name} (SKU: ${p.sku || '-'})` : 'Hi, I have a product query';
          window.open(`https://wa.me/917457994888?text=${encodeURIComponent(msg)}`, '_blank');
        });

        document.querySelectorAll('.delete-btn').forEach(b=> b.onclick = async ()=>{ const id=b.dataset.id; if(!confirm('Delete product?')) return; try{ await deleteDoc(doc(db,'products',id)); alert('Deleted'); } catch(err){ alert('Delete failed: '+err.message); } });
      });

      // Orders listener (with full address rendering)
      unsubOrders = onSnapshot(query(collection(db,'orders'), orderBy('createdAt','desc')), snap=>{
        ordersArea.innerHTML='';
        snap.forEach(s=>{
          const o = s.data(); const id = s.id;
          // address fields
          const addr = (o.address) || {};
          const line1 = addr.line1 || '';
          const line2 = addr.line2 || '';
          const city = addr.city || '';
          const state = addr.state || '';
          const pincode = addr.pincode || '';
          const country = addr.country || '';
          const formattedAddr = [line1, line2].filter(Boolean).join(', ');
          const cityLine = [city, state, pincode].filter(Boolean).join(' • ');

          const el = document.createElement('div'); el.className='order-card';
          el.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
              <div style="flex:1;min-width:0">
                <strong>${escapeHtml(o.productName||'')}</strong>
                <div class="muted">SKU: ${escapeHtml(o.productSnapshot && o.productSnapshot.sku || '')}</div>
                <div class="muted">${escapeHtml(o.customerName||'')} • ${escapeHtml(o.customerPhone||'')}</div>

                <div class="address-block">
                  <div style="font-size:13px;color:#374151;font-weight:600">Delivery address</div>
                  <div class="muted" style="margin-top:6px">${escapeHtml(formattedAddr) || 'No address provided'}</div>
                  <div class="muted">${escapeHtml(cityLine)}${country ? ' • '+escapeHtml(country) : ''}</div>
                </div>

                ${o.note ? `<div style="margin-top:8px;font-size:13px;color:${'var(--muted)'}">Note: ${escapeHtml(o.note)}</div>` : ''}
              </div>

              <div style="text-align:right;min-width:180px">
                <div style="margin-bottom:8px"><span class="status-badge">${escapeHtml(o.status||'pending')}</span></div>
                <div style="display:flex;gap:6px;flex-direction:column">
                  <div style="display:flex;gap:6px;justify-content:flex-end">
                    <button class="btn small update-status" data-id="${id}" data-status="processing">Processing</button>
                    <button class="btn small update-status" data-id="${id}" data-status="shipped">Shipped</button>
                    <button class="btn small update-status" data-id="${id}" data-status="completed">Completed</button>
                  </div>
                  <div>
                    <button class="btn secondary small delete-order" data-id="${id}">Delete</button>
                  </div>
                </div>
              </div>
            </div>
          `;
          ordersArea.appendChild(el);
        });

        // handlers
        document.querySelectorAll('.delete-order').forEach(b=> b.onclick = async ()=>{ if(!confirm('Delete order?')) return; const id=b.dataset.id; try{ await deleteDoc(doc(db,'orders',id)); alert('Deleted'); } catch(err){ alert('Delete failed: '+err.message); } });
        document.querySelectorAll('.update-status').forEach(b=> b.onclick = async ()=>{ const id=b.dataset.id; const status=b.dataset.status; try{ await updateDoc(doc(db,'orders',id), { status, updatedAt: serverTimestamp() }); } catch(err){ console.error(err); } });
      });

      // Quotes listener
      unsubQuotes = onSnapshot(query(collection(db,'quotes'), orderBy('createdAt','desc')), snap=>{
        quotesArea.innerHTML='';
        snap.forEach(qsnap=>{
          const q = qsnap.data(); const id = qsnap.id;
          const el = document.createElement('div'); el.className='order-card';
          el.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <strong>${escapeHtml(q.productName||'')}</strong>
                <div class="muted">${escapeHtml(q.name||'')} • ${escapeHtml(q.phone||'')}</div>
                ${q.message ? `<div style="margin-top:8px" class="muted">Message: ${escapeHtml(q.message)}</div>` : ''}
              </div>
              <div>
                <button class="btn secondary small delete-quote" data-id="${id}">Delete</button>
              </div>
            </div>
          `;
          quotesArea.appendChild(el);
        });

        document.querySelectorAll('.delete-quote').forEach(b=> b.onclick = async ()=>{ if(!confirm('Delete quote?')) return; const id=b.dataset.id; try{ await deleteDoc(doc(db,'quotes',id)); alert('Deleted'); } catch(err){ alert('Delete failed: '+err.message); } });
      });
    }

    function stopListeners(){ if(unsubProducts){ unsubProducts(); unsubProducts=null; } if(unsubOrders){ unsubOrders(); unsubOrders=null; } if(unsubQuotes){ unsubQuotes(); unsubQuotes=null; } productsList.innerHTML=''; ordersArea.innerHTML=''; quotesArea.innerHTML=''; }

    /* search + filter */
    searchInput?.addEventListener('input', filterProductsUI);
    filterCategory?.addEventListener('change', filterProductsUI);

    function filterProductsUI(){
      const q = (searchInput.value||'').toLowerCase();
      const cat = (filterCategory.value||'').toLowerCase();
      document.querySelectorAll('#productsList .product-item').forEach(el=>{
        const text = (el.textContent||'').toLowerCase();
        const matchesQ = !q || text.includes(q);
        const matchesCat = !cat || text.includes(cat);
        el.style.display = (matchesQ && matchesCat) ? '' : 'none';
      });
    }

    function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  </script>
</body>
</html>
