<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Advanced Product & Orders</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--primary:#D10007;--muted:#6b7280;--bg:#f7f7f8}
    body{font-family:'Poppins',sans-serif;background:var(--bg);margin:0;padding:24px;color:#111827}
    .wrap{max-width:1200px;margin:0 auto}
    h1{margin:0 0 12px}
    .layout{display:grid;grid-template-columns:380px 1fr;gap:18px;align-items:start}
    .card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    input,textarea,select,button{font-family:inherit}
    input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;margin-top:8px}
    .btn{background:var(--primary);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    .btn.secondary{background:#374151}
    .small{font-size:13px;color:var(--muted)}
    .section-title{font-size:16px;margin-bottom:8px}
    .products-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px}
    .product-item{border:1px solid #eee;padding:10px;border-radius:8px;background:#fff}
    .thumb{width:100%;height:140px;object-fit:cover;border-radius:6px}
    .row{display:flex;gap:8px}
    .row > *{flex:1}
    .orders-grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    .order-card{border:1px solid #eee;padding:12px;border-radius:10px;background:#fff}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#f3f4f6;font-size:12px}
    .field-label{font-weight:600;font-size:13px;margin-top:8px}
    .muted{color:var(--muted)}
    .link-like{background:none;border:0;color:var(--primary);cursor:pointer;text-decoration:underline;padding:0;font-size:13px}
    .gallery-preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .gallery-preview img{width:70px;height:70px;object-fit:cover;border-radius:6px}
    .inline-small{display:inline-block;padding:6px 8px;border-radius:6px;background:#f3f4f6;margin-right:6px;font-size:12px}
    .switch-row{display:flex;gap:8px;align-items:center;margin-top:8px}
    .error{background:#fee2e2;color:#991b1b;padding:8px;border-radius:8px}
    .success{background:#dcfce7;color:#065f46;padding:8px;border-radius:8px}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h1>Admin — Advanced Products & Orders</h1>
      <div style="text-align:right">
        <div id="adminInfo" class="small muted">Not signed in</div>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT: Auth + Add/Edit product -->
      <div>
        <div class="card">
          <div class="section-title">Sign in / Register</div>
          <div id="authError" style="display:none"></div>

          <input id="email" placeholder="admin@example.com" type="email" />
          <input id="password" placeholder="password (min 6 chars)" type="password" />
          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnLogin">Sign in</button>
            <button class="btn secondary" id="btnRegister">Register</button>
          </div>
          <div style="margin-top:10px">
            <button class="btn secondary" id="btnSignOut" style="display:none">Sign out</button>
          </div>
          <p class="small" style="margin-top:8px">Tip: create admin here or add via Firebase Console (Authentication → Users).</p>
        </div>

        <div class="card" id="addCard" style="margin-top:12px;display:none">
          <div class="section-title">Add / Edit Product</div>
          <div id="saveMsg" style="display:none"></div>

          <form id="productForm">
            <input id="productId" type="hidden" />
            <label class="field-label">Name</label>
            <input id="productName" placeholder="Product name" required />

            <div class="row">
              <div>
                <label class="field-label">SKU</label>
                <input id="productSKU" placeholder="SKU or item code (e.g., PRB-001)" />
              </div>
              <div>
                <label class="field-label">Type</label>
                <select id="productType">
                  <option value="ready-made">Ready-made</option>
                  <option value="customized">Customized</option>
                </select>
              </div>
            </div>

            <label class="field-label">Category</label>
            <input id="productCategory" placeholder="Category (Apparel, Mugs...)" />

            <label class="field-label">Vendor</label>
            <input id="productVendor" placeholder="Vendor / Brand" />

            <label class="field-label">Base Price (INR)</label>
            <input id="productPrice" type="number" min="0" placeholder="499" />

            <label class="field-label">Stock (if no variants)</label>
            <input id="productStock" type="number" min="0" placeholder="120" />

            <label class="field-label">Variants (JSON array — helper below)</label>
            <textarea id="productVariants" placeholder='Example: [{"id":"v1","label":"S","price":499,"stock":30},{"id":"v2","label":"M","price":499,"stock":40}]' rows="4"></textarea>
            <div class="small muted">Variants override base price/stock when provided. Use JSON array.</div>

            <label class="field-label">Sizes (comma separated)</label>
            <input id="productSizes" placeholder="S,M,L,XL" />

            <label class="field-label">Colors (comma separated)</label>
            <input id="productColors" placeholder="black,white,red" />

            <label class="field-label">Tags (comma separated)</label>
            <input id="productTags" placeholder="cotton,summer,unisex" />

            <label class="field-label">Description (long)</label>
            <textarea id="productDesc" rows="4"></textarea>

            <div style="margin-top:10px">
              <div class="small">Image source — multiple URLs OR upload</div>
              <div style="display:flex;gap:12px;margin-top:6px;align-items:center">
                <label><input type="radio" name="imgSource" value="urls" checked /> Paste URLs</label>
                <label><input type="radio" name="imgSource" value="upload" /> Upload Files</label>
              </div>
            </div>

            <label class="field-label">Image URLs (comma separated)</label>
            <textarea id="productImageUrls" placeholder="https://.../1.jpg, https://.../2.jpg" rows="3"></textarea>
            <div class="small muted">Or choose Upload Files option below.</div>

            <div id="imageUploadBox" style="display:none;margin-top:8px">
              <input id="productImageFiles" type="file" accept="image/*" multiple />
              <div id="galleryPreview" class="gallery-preview"></div>
            </div>

            <label class="field-label">Shipping weight (grams)</label>
            <input id="productWeight" type="number" min="0" placeholder="300" />

            <div class="row">
              <div>
                <label class="field-label">Length (cm)</label>
                <input id="productLength" type="number" min="0" placeholder="30" />
              </div>
              <div>
                <label class="field-label">Width (cm)</label>
                <input id="productWidth" type="number" min="0" placeholder="25" />
              </div>
            </div>
            <div class="row">
              <div>
                <label class="field-label">Height (cm)</label>
                <input id="productHeight" type="number" min="0" placeholder="2" />
              </div>
              <div>
                <label class="field-label">Featured?</label>
                <select id="productFeatured"><option value="false">No</option><option value="true">Yes</option></select>
              </div>
            </div>

            <label class="field-label">SEO Title (optional)</label>
            <input id="productSeoTitle" placeholder="SEO title" />
            <label class="field-label">SEO Description (optional)</label>
            <textarea id="productSeoDesc" rows="2"></textarea>

            <div style="display:flex;gap:8px;margin-top:12px">
              <button class="btn" type="submit" id="btnSaveProduct">Save Product</button>
              <button class="btn secondary" type="button" id="btnReset">Reset</button>
            </div>
          </form>
        </div>

      </div>

      <!-- RIGHT: Product lists and Orders -->
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="section-title">Manage Products (grouped)</div>
            <div>
              <button class="btn secondary" id="btnRefreshProducts">Refresh</button>
            </div>
          </div>

          <div style="margin-top:12px">
            <h4 style="margin:6px 0">Ready-made</h4>
            <div id="readyGrid" class="products-grid"></div>

            <h4 style="margin:16px 0 6px">Customized</h4>
            <div id="customGrid" class="products-grid"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="section-title">Orders</div>
            <div><button class="btn secondary" id="btnRefreshOrders">Refresh</button></div>
          </div>

          <div style="margin-top:10px">
            <h4 style="margin:6px 0">Ready-made Orders</h4>
            <div id="ordersReady" class="orders-grid"></div>

            <h4 style="margin:16px 0 6px">Customized Orders</h4>
            <div id="ordersCustom" class="orders-grid"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (modular) -->
  <script type="module">
    // ---------- IMPORTS ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, updateDoc, serverTimestamp, getDoc
    } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
    import {
      getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-storage.js";

    // ---------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAj405kZSn-V6rOKE1BurRE3meYCGZ_wbU",
      authDomain: "prabha-graphics-7d269.firebaseapp.com",
      projectId: "prabha-graphics-7d269",
      storageBucket: "prabha-graphics-7d269.appspot.com",
      messagingSenderId: "968671773486",
      appId: "1:968671773486:web:234c477f4ba267f31770bf",
      measurementId: "G-52C61FGY39"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ---------- UI refs ----------
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const btnLogin = document.getElementById('btnLogin');
    const btnRegister = document.getElementById('btnRegister');
    const btnSignOut = document.getElementById('btnSignOut');
    const adminInfo = document.getElementById('adminInfo');
    const authError = document.getElementById('authError');

    const addCard = document.getElementById('addCard');
    const productForm = document.getElementById('productForm');
    const productIdEl = document.getElementById('productId');
    const productName = document.getElementById('productName');
    const productSKU = document.getElementById('productSKU');
    const productType = document.getElementById('productType');
    const productCategory = document.getElementById('productCategory');
    const productVendor = document.getElementById('productVendor');
    const productPrice = document.getElementById('productPrice');
    const productStock = document.getElementById('productStock');
    const productVariants = document.getElementById('productVariants');
    const productSizes = document.getElementById('productSizes');
    const productColors = document.getElementById('productColors');
    const productTags = document.getElementById('productTags');
    const productDesc = document.getElementById('productDesc');
    const productImageUrls = document.getElementById('productImageUrls');
    const productImageFiles = document.getElementById('productImageFiles');
    const imageUploadBox = document.getElementById('imageUploadBox');
    const galleryPreview = document.getElementById('galleryPreview');
    const productWeight = document.getElementById('productWeight');
    const productLength = document.getElementById('productLength');
    const productWidth = document.getElementById('productWidth');
    const productHeight = document.getElementById('productHeight');
    const productFeatured = document.getElementById('productFeatured');
    const productSeoTitle = document.getElementById('productSeoTitle');
    const productSeoDesc = document.getElementById('productSeoDesc');
    const saveMsg = document.getElementById('saveMsg');
    const btnReset = document.getElementById('btnReset');
    const btnRefreshProducts = document.getElementById('btnRefreshProducts');

    const readyGrid = document.getElementById('readyGrid');
    const customGrid = document.getElementById('customGrid');

    const ordersReady = document.getElementById('ordersReady');
    const ordersCustom = document.getElementById('ordersCustom');
    const btnRefreshOrders = document.getElementById('btnRefreshOrders');

    // ---------- helpers ----------
    function showError(el, msg){ el.style.display='block'; el.className='error'; el.textContent = msg; }
    function showSuccess(el, msg){ el.style.display='block'; el.className='success'; el.textContent = msg; setTimeout(()=>{ el.style.display='none'; }, 3500) }
    function clearBox(el){ el.style.display='none'; el.textContent=''; el.className=''; }

    // ---------- Auth ----------
    btnLogin.addEventListener('click', async ()=> {
      clearBox(authError);
      const email = emailEl.value.trim();
      const pass = passEl.value;
      if(!email || !pass) return showError(authError,'Enter email & password.');
      try{ await signInWithEmailAndPassword(auth,email,pass); }
      catch(err){ showError(authError,'Sign-in failed: '+err.message); }
    });

    btnRegister.addEventListener('click', async ()=> {
      clearBox(authError);
      const email = emailEl.value.trim();
      const pass = passEl.value;
      if(!email || !pass) return showError(authError,'Enter email & password.');
      if(pass.length<6) return showError(authError,'Password must be at least 6 chars.');
      try{ await createUserWithEmailAndPassword(auth,email,pass); showSuccess(saveMsg,'Admin created & signed in.'); }
      catch(err){ showError(authError,'Register failed: '+err.message); }
    });

    btnSignOut.addEventListener('click', async ()=> { await signOut(auth); });

    onAuthStateChanged(auth, user => {
      clearBox(authError);
      if(user){
        adminInfo.textContent = `Signed in: ${user.email} (uid: ${user.uid})`;
        btnSignOut.style.display='inline-block';
        btnLogin.style.display='none'; btnRegister.style.display='none';
        addCard.style.display='block';
        startProductsListener(); startOrdersListener();
      } else {
        adminInfo.textContent = 'Not signed in';
        btnSignOut.style.display='none';
        btnLogin.style.display='inline-block'; btnRegister.style.display='inline-block';
        addCard.style.display='none';
        stopListeners();
        readyGrid.innerHTML = customGrid.innerHTML = ordersReady.innerHTML = ordersCustom.innerHTML = '';
      }
    });

    // ---------- Image source toggle ----------
    document.querySelectorAll('input[name="imgSource"]').forEach(r=>{
      r.addEventListener('change', ()=> {
        if (r.checked && r.value === 'upload'){ imageUploadBox.style.display='block'; productImageUrls.parentElement.style.display='none'; }
        else { imageUploadBox.style.display='none'; productImageUrls.parentElement.style.display='block'; }
      });
    });

    // preview uploaded images
    productImageFiles.addEventListener('change', ()=> {
      galleryPreview.innerHTML = '';
      const files = Array.from(productImageFiles.files || []);
      files.forEach(f=>{
        const url = URL.createObjectURL(f);
        const img = document.createElement('img');
        img.src = url;
        galleryPreview.appendChild(img);
      });
    });

    // ---------- Save product (create / update) ----------
    productForm.addEventListener('submit', async (e)=> {
      e.preventDefault();
      clearBox(saveMsg);
      const id = productIdEl.value || '';
      const name = productName.value.trim();
      const sku = productSKU.value.trim();
      const type = productType.value;
      const category = productCategory.value.trim();
      const vendor = productVendor.value.trim();
      const price = parseFloat(productPrice.value) || 0;
      const stock = parseInt(productStock.value) || 0;
      const sizes = productSizes.value.split(',').map(s=>s.trim()).filter(Boolean);
      const colors = productColors.value.split(',').map(c=>c.trim()).filter(Boolean);
      const tags = productTags.value.split(',').map(t=>t.trim()).filter(Boolean);
      const desc = productDesc.value.trim();
      const variantsText = productVariants.value.trim();
      let variants = [];
      if (variantsText) {
        try { variants = JSON.parse(variantsText); }
        catch(e){ return showError(saveMsg,'Variants JSON invalid: '+ e.message); }
      }
      const imageUrls = productImageUrls.value.split(',').map(u=>u.trim()).filter(Boolean);
      const files = Array.from(productImageFiles.files || []);
      const weight = parseFloat(productWeight.value) || 0;
      const length_cm = parseFloat(productLength.value) || 0;
      const width_cm = parseFloat(productWidth.value) || 0;
      const height_cm = parseFloat(productHeight.value) || 0;
      const featured = productFeatured.value === 'true';
      const seoTitle = productSeoTitle.value.trim();
      const seoDesc = productSeoDesc.value.trim();

      if (!name) return showError(saveMsg,'Product name required.');

      try {
        // upload files if provided
        let uploadedUrls = [];
        let uploadedPaths = [];
        if (files.length) {
          for (const f of files) {
            const path = `products/${Date.now()}_${f.name}`;
            const sRef = storageRef(storage, path);
            const task = uploadBytesResumable(sRef, f);
            await new Promise((res, rej) => {
              task.on('state_changed', ()=>{}, err=> rej(err), async ()=>{
                const url = await getDownloadURL(task.snapshot.ref);
                uploadedUrls.push(url);
                uploadedPaths.push(path);
                res();
              });
            });
          }
        }

        const images = [...imageUrls, ...uploadedUrls];

        const docData = {
          name, sku, type, category, vendor, price, stock,
          sizes, colors, tags, description: desc,
          variants, images,
          imageStoragePaths: uploadedPaths,
          shipping: { weight_g: weight, length_cm, width_cm, height_cm },
          dimensions: { length_cm, width_cm, height_cm },
          seo: { title: seoTitle, description: seoDesc },
          featured,
          createdAt: serverTimestamp()
        };

        if (!id) {
          await addDoc(collection(db, 'products'), docData);
          productForm.reset(); galleryPreview.innerHTML=''; showSuccess(saveMsg,'Product created.');
        } else {
          // update existing doc
          await updateDoc(doc(db,'products', id), docData);
          productForm.reset(); productIdEl.value=''; galleryPreview.innerHTML=''; showSuccess(saveMsg,'Product updated.');
        }

      } catch (err) {
        console.error('save product err', err);
        showError(saveMsg,'Could not save product: '+ err.message);
      }
    });

    btnReset.addEventListener('click', ()=> productForm.reset());
    btnRefreshProducts.addEventListener('click', ()=> startProductsListener(true));

    // ---------- Products list listener ----------
    let productsUnsub = null;
    function startProductsListener(force=false){
      if (productsUnsub && !force) return;
      if (productsUnsub) productsUnsub();
      const q = query(collection(db,'products'), orderBy('createdAt','desc'));
      productsUnsub = onSnapshot(q, snapshot => {
        readyGrid.innerHTML = customGrid.innerHTML = '';
        snapshot.forEach(docSnap => {
          const d = docSnap.data(); const id = docSnap.id;
          const el = document.createElement('div');
          el.className = 'product-item';
          el.innerHTML = `
            <img class="thumb" src="${(d.images && d.images[0]) || ''}" alt="${escapeHtml(d.name)}" />
            <h4 style="margin:8px 0 6px">${escapeHtml(d.name)}</h4>
            <div class="small muted">SKU: ${escapeHtml(d.sku || '')} • ${escapeHtml(d.category || '')}</div>
            <div style="margin-top:6px">${d.variants && d.variants.length ? '<span class="inline-small">Variants: '+ d.variants.length +'</span>' : '<span class="inline-small">Stock: '+ (d.stock||0) +'</span>'}<span class="badge" style="margin-left:6px">${escapeHtml(d.type||'')}</span></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn btn-edit" data-id="${id}">Edit</button>
              <button class="btn secondary btn-delete" data-id="${id}" data-path='${JSON.stringify(d.imageStoragePaths||[])}'>Delete</button>
            </div>
          `;
          if (d.type === 'customized') customGrid.appendChild(el); else readyGrid.appendChild(el);
        });

        // edit handlers
        document.querySelectorAll('.btn-edit').forEach(b=>{
          b.onclick = async ()=> {
            const id = b.dataset.id;
            const snap = await getDoc(doc(db,'products',id));
            if (!snap.exists()) return alert('Product not found');
            const d = snap.data();
            productIdEl.value = snap.id;
            productName.value = d.name || '';
            productSKU.value = d.sku || '';
            productType.value = d.type || 'ready-made';
            productCategory.value = d.category || '';
            productVendor.value = d.vendor || '';
            productPrice.value = d.price || '';
            productStock.value = d.stock || '';
            productVariants.value = d.variants && d.variants.length ? JSON.stringify(d.variants,null,2) : '';
            productSizes.value = (d.sizes||[]).join(',');
            productColors.value = (d.colors||[]).join(',');
            productTags.value = (d.tags||[]).join(',');
            productDesc.value = d.description || '';
            productImageUrls.value = (d.images||[]).join(',');
            productSeoTitle.value = (d.seo && d.seo.title) || '';
            productSeoDesc.value = (d.seo && d.seo.description) || '';
            productWeight.value = (d.shipping && d.shipping.weight_g) || '';
            productLength.value = (d.dimensions && d.dimensions.length_cm) || '';
            productWidth.value = (d.dimensions && d.dimensions.width_cm) || '';
            productHeight.value = (d.dimensions && d.dimensions.height_cm) || '';
            productFeatured.value = d.featured ? 'true':'false';
            // preview gallery
            galleryPreview.innerHTML = '';
            (d.images||[]).forEach(url=>{
              const img = document.createElement('img'); img.src = url; galleryPreview.appendChild(img);
            });
            window.scrollTo({top:0, behavior:'smooth'});
          };
        });

        // delete handlers
        document.querySelectorAll('.btn-delete').forEach(b=>{
          b.onclick = async ()=> {
            if (!confirm('Delete product?')) return;
            const id = b.dataset.id;
            const paths = JSON.parse(b.getAttribute('data-path')||'[]');
            try {
              await deleteDoc(doc(db, 'products', id));
              // delete storage objects if any
              for (const p of paths){
                try{ await deleteObject(storageRef(storage, p)); } catch(e){ console.warn('delete storage err', e.message); }
              }
              showSuccess(saveMsg,'Product deleted.');
            } catch (err){ showError(saveMsg,'Delete failed: '+ err.message); }
          };
        });

      }, err => { showError(saveMsg,'Could not load products: '+ err.message); });
    }

    // ---------- Orders listener ----------
    let ordersUnsub = null;
    function startOrdersListener(force=false){
      if (ordersUnsub && !force) return;
      if (ordersUnsub) ordersUnsub();
      const q = query(collection(db,'orders'), orderBy('createdAt','desc'));
      ordersUnsub = onSnapshot(q, snapshot=>{
        ordersReady.innerHTML = ordersCustom.innerHTML = '';
        snapshot.forEach(docSnap=>{
          const o = docSnap.data(); const id = docSnap.id;
          const target = (o.productType === 'customized') ? ordersCustom : ordersReady;
          const el = document.createElement('div');
          el.className = 'order-card';
          el.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:700">${escapeHtml(o.productName || '')} ${o.variantLabel ? '('+escapeHtml(o.variantLabel)+')':''}</div>
                <div class="small muted">${escapeHtml(o.customerName || '')} • ${escapeHtml(o.customerPhone || '')}</div>
              </div>
              <div style="text-align:right">
                <div class="small">Qty: ${escapeHtml(String(o.quantity||1))}</div>
                <div style="margin-top:6px"><span class="badge">${escapeHtml(o.status || 'pending')}</span></div>
              </div>
            </div>
            <div style="margin-top:8px;color:#374151">${escapeHtml(o.address.line1 || '')} ${escapeHtml(o.address.line2 || '')}, ${escapeHtml(o.address.city || '')} - ${escapeHtml(o.address.pincode || '')}</div>
            <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
              <button class="btn btn-mark" data-id="${id}" data-status="processing">Processing</button>
              <button class="btn secondary btn-mark" data-id="${id}" data-status="shipped">Shipped</button>
              <button class="btn secondary btn-mark" data-id="${id}" data-status="delivered">Delivered</button>
              <button class="btn secondary btn-view" data-id="${id}">View</button>
              <button class="btn secondary btn-delete-order" data-id="${id}">Delete Order</button>
            </div>
          `;
          target.appendChild(el);
        });

        // handlers
        document.querySelectorAll('.btn-mark').forEach(b=>{
          b.onclick = async ()=> {
            const id = b.dataset.id; const status = b.dataset.status;
            try { await updateDoc(doc(db,'orders',id), { status, updatedAt: serverTimestamp() }); }
            catch(err){ console.error('status update err', err); }
          };
        });

        document.querySelectorAll('.btn-view').forEach(b=>{
          b.onclick = async ()=> {
            const id = b.dataset.id;
            const snap = await getDoc(doc(db,'orders',id));
            if(!snap.exists()) return alert('Order not found');
            const o = snap.data();
            const details = [
              `Product: ${o.productName} ${o.variantLabel? '('+o.variantLabel+')':''}`,
              `Type: ${o.productType}`,
              `Qty: ${o.quantity}`,
              `Size: ${o.size || 'N/A'}`,
              `Name: ${o.customerName}`,
              `Phone: ${o.customerPhone}`,
              `Email: ${o.customerEmail || 'N/A'}`,
              `Address: ${o.address.line1 || ''} ${o.address.line2 || ''}, ${o.address.city || ''} - ${o.address.pincode || ''}`,
              `Note: ${o.note || 'N/A'}`,
              `Status: ${o.status || 'pending'}`
            ].join('\n\n');
            alert(details);
          };
        });

        document.querySelectorAll('.btn-delete-order').forEach(b=>{
          b.onclick = async ()=> {
            if(!confirm('Delete this order?')) return;
            const id = b.dataset.id;
            try{ await deleteDoc(doc(db,'orders',id)); alert('Deleted'); }
            catch(err){ alert('Delete failed: '+ err.message); }
          };
        });

      }, err => { console.error('orders snapshot', err); });
    }

    function stopListeners(){ if(productsUnsub) productsUnsub(); if(ordersUnsub) ordersUnsub(); productsUnsub = ordersUnsub = null; }
    btnRefreshOrders.addEventListener('click', ()=> startOrdersListener(true));

    // ---------- small util ----------
    function escapeHtml(str=''){ return String(str).replace(/[&<>"']/g,m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

  </script>
</body>
</html>
