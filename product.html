<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="description" content="Prabha Graphics - Catalog" />
  <title>Prabha Graphics — Products</title>

  <!-- Fonts & Icons (same as your header) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* ---------- Reuse header/footer styles (kept minimal here for page alignment) ---------- */
    :root{--primary-red:#D10007;--dark-red:#A00006;--white:#fff;--gray-100:#f3f4f6;--gray-800:#1f2937}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Poppins',sans-serif;background:var(--white);color:var(--gray-800);line-height:1.4}
    .container{max-width:1280px;margin:0 auto;padding:0 28px}
    /* ---------- header/footer (copied from your provided header) ---------- */
    .navbar{position:fixed;top:0;left:0;right:0;background:var(--white);z-index:1000;box-shadow:0 0 0 rgba(0,0,0,0);transition:all .25s}
    .nav-container{max-width:1280px;margin:0 auto;padding:16px 28px;display:flex;align-items:center;gap:16px;justify-content:space-between}
    .nav-logo{display:flex;align-items:center;gap:8px;cursor:pointer}
    .logo-circle{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--primary-red);color:#fff;font-weight:700}
    .logo-text{font-weight:700;font-size:18px}
    .nav-links{display:flex;gap:20px;list-style:none;align-items:center}
    .nav-link{text-decoration:none;color:var(--gray-800);font-weight:500}
    .cta-btn{background:var(--primary-red);color:#fff;padding:8px 16px;border-radius:8px;border:0;cursor:pointer}
    .hamburger{display:none}
    /* ---------- page layout ---------- */
    .hero {height:320px;background:linear-gradient(90deg,#fef2f2,#fff);display:flex;align-items:center;margin-top:80px}
    .hero .container{display:flex;gap:24px;align-items:center}
    .hero .left{flex:1}
    .hero h1{font-size:34px;margin-bottom:8px}
    .hero p{color:#6b7280}
    /* category cards */
    .categories-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;margin:28px 0}
    .category-card{position:relative;border-radius:12px;overflow:hidden;cursor:pointer;min-height:160px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .category-card img{width:100%;height:100%;object-fit:cover;display:block}
    .category-overlay{position:absolute;inset:0;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.5));display:flex;align-items:flex-end;padding:16px;color:#fff}
    .section{margin:28px 0;padding:18px;border-radius:12px;background:var(--gray-100)}
    .section h2{margin-bottom:12px}
    .products-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .product-card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.06);display:flex;flex-direction:column}
    .product-card img{width:100%;height:180px;object-fit:cover}
    .product-body{padding:12px;flex:1;display:flex;flex-direction:column}
    .price{font-weight:700;color:var(--primary-red);margin-top:6px}
    .row{display:flex;gap:8px;align-items:center}
    .btn{background:var(--primary-red);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    /* modal styles */
    .modal-bg{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:2000}
    .modal{width:96%;max-width:900px;background:#fff;border-radius:12px;padding:16px;max-height:90vh;overflow:auto}
    .gallery{display:flex;gap:8px;margin-top:8px}
    .gallery img{width:80px;height:80px;object-fit:cover;border-radius:6px}
    /* order form styles */
    .form-row{display:flex;gap:8px}
    .form-row > *{flex:1}
    .footer{background:#111827;color:#fff;padding:48px 0;margin-top:28px}
    .footer .container{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px}
    .footer .logo-circle{width:40px;height:40px}
    /* responsive */
    @media (max-width:900px){ .form-row{flex-direction:column} .nav-links{display:none} .hamburger{display:block} .hero{height:360px} }
  </style>
</head>
<body>

  <!-- NAV (copied exactly from your header, with Get a Quote linking to quote page) -->
  <nav class="navbar" id="navbar">
    <div class="nav-container container">
      <div class="nav-logo" onclick="location.href='index.html'">
        <div class="logo-circle">PG</div>
        <span class="logo-text">Prabha Graphics</span>
      </div>

      <ul class="nav-links" id="navLinks">
        <li><a class="nav-link" href="index.html#home">Home</a></li>
        <li><a class="nav-link" href="index.html#about">About Us</a></li>
        <li><a class="nav-link" href="products.html#corporate">Corporate Gifts</a></li>
        <li><a class="nav-link" href="products.html#personalized">Personalized Gifts</a></li>
        <li><a class="nav-link" href="products.html#business">Business Essentials</a></li>
        <li><a class="nav-link" href="index.html#contact">Contact Us</a></li>
      </ul>

      <div style="display:flex;gap:12px;align-items:center">
        <button class="cta-btn" onclick="location.href='get-a-quote.html'">Get a Quote</button>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <section class="hero">
    <div class="container">
      <div class="left">
        <h1>All Products — Find exactly what you need</h1>
        <p>Browse corporate gifts, promotional items, personalized treasures, business essentials and ready-made products. Click category to jump.</p>
      </div>
      <div class="right">
        <!-- simple image -->
        <img src="https://images.unsplash.com/photo-1556821552-5f73541e6b1e?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&q=80&w=600" alt="" style="width:240px;border-radius:10px;object-fit:cover" />
      </div>
    </div>
  </section>

  <div class="container" style="padding-top:18px;">

    <!-- Category cards that link to product sections -->
    <div class="categories-grid">
      <div class="category-card" data-target="corporate" onclick="scrollToSection('corporate')">
        <img src="https://images.unsplash.com/photo-1612521334484-bfb1f3f0cedc?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&q=80&w=800" alt="Corporate"/>
        <div class="category-overlay"><div><h3>Corporate & Promotional</h3><p>Keychains, Pens, Gift Sets</p></div></div>
      </div>

      <div class="category-card" data-target="personalized" onclick="scrollToSection('personalized')">
        <img src="https://images.unsplash.com/photo-1572302265669-2acefa827fca?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&q=80&w=800" alt="Personalized"/>
        <div class="category-overlay"><div><h3>Personalized Gifts</h3><p>Mugs, Cushions, Photo Gifts</p></div></div>
      </div>

      <div class="category-card" data-target="business" onclick="scrollToSection('business')">
        <img src="https://images.unsplash.com/photo-1599909695241-b6c7e2ae4e6e?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&q=80&w=800" alt="Business"/>
        <div class="category-overlay"><div><h3>Business Essentials</h3><p>Visiting cards, Stationery</p></div></div>
      </div>

      <div class="category-card" data-target="apparel" onclick="scrollToSection('apparel')">
        <img src="https://images.unsplash.com/photo-1586419604178-25ade1770efc?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&q=80&w=800" alt="Apparel"/>
        <div class="category-overlay"><div><h3>Apparel</h3><p>T-Shirts, Polo, Jackets</p></div></div>
      </div>
    </div>

    <!-- Product Sections: each section will be dynamically filled from Firestore -->
    <section id="corporate" class="section" aria-label="Corporate Gifts Section">
      <h2>Corporate & Promotional</h2>
      <div id="corporateGrid" class="products-grid"></div>
    </section>

    <section id="personalized" class="section" aria-label="Personalized Gifts Section">
      <h2>Personalized Gifts</h2>
      <div id="personalizedGrid" class="products-grid"></div>
    </section>

    <section id="business" class="section" aria-label="Business Essentials Section">
      <h2>Business Essentials</h2>
      <div id="businessGrid" class="products-grid"></div>
    </section>

    <section id="apparel" class="section" aria-label="Apparel Section">
      <h2>Apparel & Wearables</h2>
      <div id="apparelGrid" class="products-grid"></div>
    </section>

    <!-- All other products fallback section -->
    <section id="other" class="section" aria-label="Other Products Section">
      <h2>Other Products</h2>
      <div id="otherGrid" class="products-grid"></div>
    </section>

  </div>

  <!-- Product detail modal -->
  <div id="detailModal" class="modal-bg" role="dialog" aria-hidden="true">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 id="dName"></h3>
          <div id="dSku" class="muted" style="color:#6b7280"></div>
        </div>
        <button onclick="closeDetail()" class="btn" style="background:#ccc;color:#111">Close</button>
      </div>

      <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:260px">
          <img id="dImage" src="" alt="" style="width:100%;height:360px;object-fit:cover;border-radius:8px"/>
          <div class="gallery" id="dGallery"></div>
        </div>

        <div style="flex:1;min-width:260px">
          <div id="dVendor" style="color:#6b7280"></div>
          <p id="dDesc" style="margin-top:10px;color:#374151"></p>
          <div id="dVariant" style="margin-top:12px"></div>
          <div class="price" id="dPrice" style="margin-top:12px"></div>
          <div id="dStock" style="color:#6b7280;margin-top:6px"></div>

          <div style="margin-top:14px;display:flex;gap:8px">
            <button id="dWhats" class="btn">WhatsApp</button>
            <button id="dOrder" class="btn" style="background:#374151">Order Now</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Order modal -->
  <div id="orderModal" class="modal-bg" aria-hidden="true">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Place Order</h3>
        <button onclick="closeOrder()" class="btn" style="background:#ccc;color:#111">Close</button>
      </div>

      <form id="orderForm" style="margin-top:12px">
        <div class="form-row">
          <input id="oName" placeholder="Full name" required />
          <input id="oPhone" placeholder="Phone (required)" required />
        </div>

        <div style="margin-top:8px">
          <input id="oEmail" placeholder="Email (optional)" />
        </div>

        <div style="margin-top:8px">
          <input id="oLine1" placeholder="Address line 1 (house/building/street)" />
        </div>

        <div style="margin-top:8px">
          <input id="oLine2" placeholder="Address line 2 (area/landmark)" />
        </div>

        <div class="form-row" style="margin-top:8px">
          <input id="oCity" placeholder="City" />
          <input id="oState" placeholder="State" />
        </div>

        <div class="form-row" style="margin-top:8px">
          <input id="oPincode" placeholder="Pincode" />
          <input id="oCountry" placeholder="Country" value="India" />
        </div>

        <div id="orderVariantBlock" style="margin-top:10px"></div>

        <div class="form-row" style="margin-top:8px">
          <input id="oQty" type="number" min="1" value="1" />
          <select id="oPayment">
            <option>COD</option><option>Online</option>
          </select>
        </div>

        <textarea id="oNote" placeholder="Additional note (optional)" rows="3" style="margin-top:8px"></textarea>

        <label style="display:flex;align-items:center;gap:8px;margin-top:8px">
          <input type="checkbox" id="oWhatsapp" /> <span style="color:#6b7280">Also send this order via WhatsApp</span>
        </label>

        <div id="oMsg" style="margin-top:10px"></div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" type="submit">Submit Order</button>
          <button type="button" onclick="closeOrder()" class="btn" style="background:#6b7280">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Footer (copied from your footer) -->
  <footer class="footer" id="contact">
    <div class="container">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px">
        <div>
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
            <div class="logo-circle">PG</div><strong>Prabha Graphics</strong>
          </div>
          <p style="color:#d1d5db">Your trusted partner in Lucknow for all corporate and personalized printing and gifting needs.</p>
        </div>
        <div>
          <h4 style="color:#fff">Quick Links</h4>
          <ul style="list-style:none;margin-top:8px;color:#d1d5db">
            <li>T-Shirts</li><li>Mugs</li><li>Keychains</li>
          </ul>
        </div>
        <div>
          <h4 style="color:#fff">Company</h4>
          <ul style="list-style:none;margin-top:8px;color:#d1d5db">
            <li>About Us</li><li>Contact Us</li><li><a href="get-a-quote.html" style="color:#d1d5db">View Full Catalog</a></li>
          </ul>
        </div>
        <div>
          <h4 style="color:#fff">Contact Us</h4>
          <p style="color:#d1d5db"><i class="fas fa-phone"></i> 074579 94888</p>
          <p style="color:#d1d5db"><i class="fas fa-map-marker-alt"></i> Shop No. 4/74, Gomti Nagar, Lucknow, 226010</p>
          <p style="color:#d1d5db"><i class="fas fa-globe"></i> www.prabhagraphics.in</p>
        </div>
      </div>
      <div style="height:1px;background:linear-gradient(to right, transparent, rgba(209,0,7,0.3), transparent);margin:18px 0"></div>
      <div style="text-align:center;color:#9ca3af">&copy; 2025 Prabha Graphics. All rights reserved.</div>
    </div>
  </footer>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

    // --- Firebase config (your config) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAj405kZSn-V6rOKE1BurRE3meYCGZ_wbU",
      authDomain: "prabha-graphics-7d269.firebaseapp.com",
      projectId: "prabha-graphics-7d269",
      storageBucket: "prabha-graphics-7d269.appspot.com",
      messagingSenderId: "968671773486",
      appId: "1:968671773486:web:234c477f4ba267f31770bf",
      measurementId: "G-52C61FGY39"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const shopPhone = "917457994888"; // wa.me format

    // DOM refs
    const corporateGrid = document.getElementById('corporateGrid');
    const personalizedGrid = document.getElementById('personalizedGrid');
    const businessGrid = document.getElementById('businessGrid');
    const apparelGrid = document.getElementById('apparelGrid');
    const otherGrid = document.getElementById('otherGrid');

    // Modal refs
    const detailModal = document.getElementById('detailModal');
    const dName = document.getElementById('dName');
    const dSku = document.getElementById('dSku');
    const dVendor = document.getElementById('dVendor');
    const dImage = document.getElementById('dImage');
    const dGallery = document.getElementById('dGallery');
    const dDesc = document.getElementById('dDesc');
    const dVariant = document.getElementById('dVariant');
    const dPrice = document.getElementById('dPrice');
    const dStock = document.getElementById('dStock');
    const dWhats = document.getElementById('dWhats');
    const dOrder = document.getElementById('dOrder');

    const orderModal = document.getElementById('orderModal');
    const orderForm = document.getElementById('orderForm');
    const orderVariantBlock = document.getElementById('orderVariantBlock');
    const oMsg = document.getElementById('oMsg');

    let activeProduct = null;

    // Listen products collection
    const qProducts = query(collection(db, 'products'), orderBy('createdAt', 'desc'));
    onSnapshot(qProducts, snapshot => {
      // clear
      corporateGrid.innerHTML = personalizedGrid.innerHTML = businessGrid.innerHTML = apparelGrid.innerHTML = otherGrid.innerHTML = '';
      snapshot.forEach(docSnap => {
        const p = docSnap.data(); p.id = docSnap.id;
        const card = createProductCard(p);
        // map category to section
        const cat = (p.category || '').toLowerCase();
        if (cat.includes('corporate') || cat.includes('promot')) corporateGrid.appendChild(card);
        else if (cat.includes('personal')) personalizedGrid.appendChild(card);
        else if (cat.includes('business') || cat.includes('essent')) businessGrid.appendChild(card);
        else if (cat.includes('apparel') || cat.includes('shirt') || cat.includes('t-shirt')) apparelGrid.appendChild(card);
        else otherGrid.appendChild(card);
      });
      // If page opened with hash, scroll to it
      setTimeout(()=> {
        const h = location.hash.replace('#','');
        if (h) scrollToSection(h);
      }, 200);
    });

    function createProductCard(p){
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <img src="${escapeHtml((p.images && p.images[0]) || p.image || '')}" alt="${escapeHtml(p.name)}"/>
        <div class="product-body">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>${escapeHtml(p.name)}</strong>
              <div style="color:#6b7280;font-size:13px">${escapeHtml(p.vendor||'')}</div>
            </div>
            <div class="price">₹${escapeHtml(String(p.price||0))}</div>
          </div>
          <p style="color:#374151;margin-top:8px">${escapeHtml((p.description||'').slice(0,100))}...</p>
          <div style="margin-top:auto;display:flex;gap:8px;align-items:center">
            <button class="btn" onclick='openDetail("${p.id}")'>View</button>
            <div style="margin-left:auto"><span style="background:#f3f4f6;padding:6px 8px;border-radius:8px;font-size:12px">${escapeHtml(p.type||'ready-made')}</span></div>
          </div>
        </div>
      `;
      // attach store product data for quick lookup
      card.dataset.productId = p.id;
      // store in window map for quick access
      window._prabhaProducts = window._prabhaProducts || {}; window._prabhaProducts[p.id] = p;
      return card;
    }

    // scroll helper
    function scrollToSection(id){
      const el = document.getElementById(id);
      if (!el) return;
      el.scrollIntoView({behavior:'smooth', block:'start'});
      // highlight briefly
      el.style.boxShadow = '0 6px 24px rgba(209,0,7,0.12)';
      setTimeout(()=> el.style.boxShadow = '', 1600);
    }
    window.scrollToSection = scrollToSection;

    // open product modal by id
    window.openDetail = function(id){
      const p = window._prabhaProducts && window._prabhaProducts[id];
      if (!p) return alert('Product not found');
      activeProduct = p;
      dName.textContent = p.name;
      dSku.textContent = p.sku ? 'SKU: '+p.sku : '';
      dVendor.textContent = p.vendor || '';
      dImage.src = (p.images && p.images[0]) || p.image || '';
      dGallery.innerHTML = '';
      (p.images || []).forEach(u => {
        const img = document.createElement('img'); img.src = u; dGallery.appendChild(img);
      });
      dDesc.textContent = p.description || '';
      dPrice.textContent = '₹' + (p.price || 0);
      dStock.textContent = (p.variants && p.variants.length) ? ('Variants: '+p.variants.length) : ('Stock: '+(p.stock||0));
      // render variant select in modal
      dVariant.innerHTML = '';
      if (p.variants && p.variants.length){
        const s = document.createElement('select');
        s.id = 'modalVariantSelect';
        p.variants.forEach(v => s.innerHTML += `<option value='${encodeURIComponent(JSON.stringify(v))}'>${v.label} ${v.price ? ' - ₹'+v.price : ''} ${v.stock ? ' ('+v.stock+' in stock)' : ''}</option>`);
        dVariant.appendChild(s);
      }
      // show/hide order button
      if (p.type === 'customized'){
        dOrder.style.display = 'none';
        dWhats.onclick = ()=> {
          const msg = `Hello, I'm interested in this customized product: ${p.name} (SKU: ${p.sku || '-'})`;
          window.open(`https://wa.me/${shopPhone}?text=${encodeURIComponent(msg)}`, '_blank');
        };
      } else {
        dOrder.style.display = 'inline-block';
        dWhats.onclick = ()=> {
          const msg = `Hi, query about: ${p.name} (SKU: ${p.sku || '-'})`;
          window.open(`https://wa.me/${shopPhone}?text=${encodeURIComponent(msg)}`, '_blank');
        };
        dOrder.onclick = ()=> openOrderModal(p);
      }
      detailModal.style.display = 'flex'; detailModal.setAttribute('aria-hidden','false');
    };

    function closeDetail(){ detailModal.style.display='none'; detailModal.setAttribute('aria-hidden','true'); activeProduct=null; }

    // Order modal
    function openOrderModal(p){
      activeProduct = p;
      orderVariantBlock.innerHTML = '';
      // variant select (if available)
      if (p.variants && p.variants.length){
        const sel = document.createElement('select'); sel.id = 'orderVariant';
        sel.innerHTML = '<option value="">Select variant</option>';
        p.variants.forEach(v=> sel.innerHTML += `<option value='${encodeURIComponent(JSON.stringify(v))}'>${v.label}${v.price?' - ₹'+v.price:''}${v.stock?' ('+v.stock+' in stock)':''}</option>`);
        orderVariantBlock.appendChild(sel);
      }
      // sizes
      if (p.sizes && p.sizes.length){
        const sel2 = document.createElement('select'); sel2.id='orderSize';
        sel2.innerHTML = '<option value="">Select size</option>';
        p.sizes.forEach(s=> sel2.innerHTML += `<option>${s}</option>`);
        orderVariantBlock.appendChild(sel2);
      }
      // colors
      if (p.colors && p.colors.length){
        const sel3 = document.createElement('select'); sel3.id='orderColor';
        sel3.innerHTML = '<option value="">Select color</option>';
        p.colors.forEach(c=> sel3.innerHTML += `<option>${c}</option>`);
        orderVariantBlock.appendChild(sel3);
      }
      orderModal.style.display='flex'; orderModal.setAttribute('aria-hidden','false');
    }
    function closeOrder(){ orderModal.style.display='none'; orderModal.setAttribute('aria-hidden','true'); orderForm.reset(); oMsg.innerHTML=''; }

    // submit order -> save to Firestore orders
    orderForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!activeProduct) return showOrderError('No product selected.');
      const name = document.getElementById('oName').value.trim();
      const phone = document.getElementById('oPhone').value.trim();
      if (!name || !phone) return showOrderError('Name and phone required.');
      const email = document.getElementById('oEmail').value.trim();
      const line1 = document.getElementById('oLine1').value.trim();
      const line2 = document.getElementById('oLine2').value.trim();
      const city = document.getElementById('oCity').value.trim();
      const state = document.getElementById('oState').value.trim();
      const pincode = document.getElementById('oPincode').value.trim();
      const country = document.getElementById('oCountry').value.trim();
      const qty = parseInt(document.getElementById('oQty').value) || 1;
      const note = document.getElementById('oNote').value.trim();
      const alsoWhats = document.getElementById('oWhatsapp').checked;
      const paymentMethod = document.getElementById('oPayment').value;

      // selected variant
      let variant = null;
      const vsel = document.getElementById('orderVariant');
      if (vsel && vsel.value) variant = JSON.parse(decodeURIComponent(vsel.value));

      // selected size/color
      const size = document.getElementById('orderSize') ? document.getElementById('orderSize').value : '';
      const color = document.getElementById('orderColor') ? document.getElementById('orderColor').value : '';

      const order = {
        productId: activeProduct.id,
        productName: activeProduct.name,
        productSnapshot: {
          name: activeProduct.name,
          sku: activeProduct.sku || '',
          images: activeProduct.images || [],
          vendor: activeProduct.vendor || ''
        },
        productType: activeProduct.type || 'ready-made',
        variantId: variant ? variant.id : '',
        variantLabel: variant ? variant.label : '',
        variantPrice: variant ? (variant.price || activeProduct.price) : activeProduct.price,
        selectedSize: size || '',
        selectedColor: color || '',
        quantity: qty,
        customerName: name,
        customerPhone: phone,
        customerEmail: email || '',
        address: { line1, line2, city, state, pincode, country },
        paymentMethod,
        note: note || '',
        status: 'pending',
        createdAt: serverTimestamp()
      };

      try {
        const ordersCol = collection(db, 'orders');
        await addDoc(ordersCol, order);
        showOrderSuccess('Order saved. We will contact you soon.');
        if (alsoWhats){
          const lines = [
            `New order - ${activeProduct.name}`,
            `Qty: ${qty}`,
            `Size: ${order.selectedSize || '-'}`,
            `Color: ${order.selectedColor || '-'}`,
            `Name: ${name}`,
            `Phone: ${phone}`,
            `Address: ${line1} ${line2}, ${city} - ${pincode}`,
            `Note: ${note || '-'}`
          ].join('\n');
          setTimeout(()=> window.open(`https://wa.me/${shopPhone}?text=${encodeURIComponent(lines)}`, '_blank'), 700);
        }
        setTimeout(()=> closeOrder(), 900);
      } catch (err) {
        console.error('order save failed', err);
        showOrderError('Could not submit order: '+ err.message);
      }
    });

    function showOrderError(msg){ oMsg.innerHTML = `<div style="background:#fee2e2;padding:8px;border-radius:8px;color:#991b1b">${escapeHtml(msg)}</div>`; }
    function showOrderSuccess(msg){ oMsg.innerHTML = `<div style="background:#dcfce7;padding:8px;border-radius:8px;color:#065f46">${escapeHtml(msg)}</div>`; }

    // small helpers
    function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
  </script>
</body>
</html>
